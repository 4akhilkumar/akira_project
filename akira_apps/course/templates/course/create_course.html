{% extends 'side_panel-navbar_dashboard.html' %}
{% load static %}

{% block content %}

{% block analytics-text %}
<h1>Create Course</h1>
<p>An integrated course prepared for academic studies <span class="fas fa-chart-line"></span> </p>
{% endblock %}

{% block create-course %}
<div class="regiserformcontainer">
    <form id="msform" action="" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <fieldset>
            <div class="form-card">
                <div class="field-container">
                    <div class="input-box">
                        <label class="fieldlabels input-label" for="id_course_code">Code</label>
                        <input type="text" name="course_code" id="id_course_code" spellcheck="false" class="input-1" onfocus="setFocus(true)" onblur="setFocus(false)" required>
                        <span class="error-text">Enter course code</span>
                    </div>
                    <div class="input-box">
                        <label class="fieldlabels input-label" for="id_course_name">Name</label> 
                        <input type="text" name="course_name" id="id_course_name" class="input-1" onfocus="setFocus(true)" onblur="setFocus(false)" required>
                        <span class="error-text">Enter course name</span>
                    </div>
                </div>

                <div class="field-container mb-1rem">
                    <div class="input-box">
                        <label class="fieldlabels input-label" for="id_course_desc">Description</label>
                        <textarea name="course_desc" maxlength="500" id="id_course_desc" class="input-1" onfocus="setFocus(true)" onblur="setFocus(false)" required></textarea>
                        <span class="help-text">Maximum characters allowed is 500 only.</span>
                        <span class="error-text">Enter course description</span>
                        <span class="info-text"></span>
                    </div>
                </div>

                <div class="field-container mb-1rem">
                    <div class="input-box active-grey">
                        <label class="fieldlabels input-label" for="id_branch">Branch</label>
                        <select name="branch" class="input-1" id="id_branch" required>
                            {% if branch_list %}
                            <option value="">Select Branch</option>
                            {% endif %}
                            {% for branch in branch_list %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                            {% empty %}
                            <option value="">Data Not Available</option>
                            {% endfor %}
                        </select>
                        <span class="error-text">Select branch</span>
                        <span class="redirect">
                            <a href="#" id="showFormCreateBranch"><i class="fa-solid fa-circle-plus"></i> Create branch</a>
                            <a href="#" id="fetchBranches">
                                <i class="fa-solid fa-arrows-rotate"></i> refresh
                            </a>
                        </span>
                    </div>
                    <div class="input-box active-grey">
                        <label class="fieldlabels input-label" for="id_semester">Semester</label>
                        <select name="semester" class="input-1" id="id_semester" required>
                            {% for i in semester_list %}
                            <option value="{{ i.id }}"> {{ i }} </option>
                            {% empty %}
                            <option value="">Data Not Available</option>
                            {% endfor %}
                        </select>
                        <span class="error-text">Select semester</span>
                        <span class="redirect">
                            <a href="#" target="_blank"><i class="fa-solid fa-circle-plus"></i> Create semester</a>
                            <a href="#" id="fetchSemester">
                                <i class="fa-solid fa-arrows-rotate"></i> refresh
                            </a>
                        </span>
                    </div>
                </div>
                
                <div class="field-container mb-2rem">
                    <div class="input-box active-grey">
                        <label class="fieldlabels input-label" for="id_specialization">Specialization</label>
                        <select name="specialization" class="input-1" id="id_specialization">
                            {% for i in specialization_list %}
                            <option value="{{ i.id }}"> {{ i }} </option>
                            {% empty %}
                            <option value="">Data Not Available</option>
                            {% endfor %}
                        </select>
                        <span class="error-text">Select specialization</span>
                        <span class="redirect">
                            <a href="#" target="_blank"><i class="fa-solid fa-circle-plus"></i> Create specialization</a>
                            <a href="#" id="fetchSpec">
                                <i class="fa-solid fa-arrows-rotate"></i> refresh
                            </a>
                        </span>
                    </div>
                    <div class="input-box active-grey">
                        <label class="fieldlabels input-label" for="id_course_coordinator">Course Co-Ordinator</label>
                        <select name="course_coordinator" class="input-1" id="id_course_coordinator">
                            <option value="">Select Faculty</option>
                            {% for i in faculty_list %}
                            <option value="{{ i.id }}"> {{ i }} </option>
                            {% empty %}
                            <option value="">Data Not Available</option>
                            {% endfor %}
                        </select>
                        <span class="error-text">Select Course Co-Ordinator</span>
                        <span class="redirect">
                            <a href="#" target="_blank"><i class="fa-solid fa-circle-plus"></i> Add faculty</a>
                            <a href="#" id="fetchFaculty">
                                <i class="fa-solid fa-arrows-rotate"></i> refresh
                            </a>
                        </span>
                    </div>
                </div>
                
                <div class="input-box active-grey-1">
                    <label class="fieldlabels input-label" for="id_course_files">Upload files</label>
                    <input type="file" name="course_files" id="id_course_files" class="input-1 custom-input-file" multiple>
                    <span class="help-text">Uploading files is optional</span>
                </div>
            </div>
            <button id="course-btn" class="action-button course-btn">Create</button>
        </fieldset>
    </form>
</div>

<div id="myModal" class="modal">
  <div class="model-container">
    <div class="modal-content">
      <div class="modal-top-section">
        <h3>Create <span class="underline">Branch</span></h3>
        <span id="close-model" class="close">&times;</span>
      </div>
      <div class="regiserformcontainer">
        <form id="msform" class="branch_form" action="" method="POST">
          {% csrf_token %}
          <fieldset>
            <div class="form-card">
              <div class="field-container">
                <div class="input-box">
                  <label class="fieldlabels input-label" for="id_branch_name">Name</label> 
                  <input type="text" name="name" id="id_branch_name" class="input-1" onfocus="setFocus(true)" onblur="setFocus(false)" required>
                  <span class="error-text">Enter branch name</span>
                </div>
              </div>
  
              <div class="field-container mb-1rem">
                <div class="input-box">
                  <label class="fieldlabels input-label" for="id_branch_desc">Description</label>
                  <textarea name="desc" maxlength="500" id="id_branch_desc" class="input-1" onfocus="setFocus(true)" onblur="setFocus(false)" required></textarea>
                  <span class="help-text">Maximum characters allowed is 500 only.</span>
                  <span class="error-text">Enter branch description</span>
                  <span class="info-text"></span>
                </div>
              </div>
            </div>
            <button type="button" id="branch-btn" data-create-branch-url="{% url 'createbranch' %}" class="action-button branch-btn">Create</button>
          </fieldset>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/course.js' %}"></script>
<script>
$(document).ready(function() {
    function getAllBranchesFunc() {

        if($(this).hasClass('anchor-disabled')){
            return false;
        }
        $(this).addClass('anchor-disabled');
        setTimeout(function(){
            $("#fetchBranches").removeClass('anchor-disabled');
        }, 5000);

        $.ajax({
            type: "GET",
            url: '{% url "getAllBranches" %}',
            success: function (data) {
                if(data.length == 0) {
                    toastr.info("No branches available")
                }
                else {
                    toastr.success("Branches list fetched successfully")
                    let html_data = '<option value=""> Select Branch </option>';
                    data.forEach(function (data) {
                        html_data += `<option value="${data.id}">${data.name}</option>`
                    });
                    $("#id_branch").html(html_data);
                }
            },
            error: function (data) {
                console.log(data);
            }
        });
    }

    function createBranchFunc() {
        var branch_name = $('#id_branch_name').val();
        var branch_desc = $('#id_branch_desc').val();
        
        if($(this).hasClass('create-branch-disabled')){
            return false;
        }
        $(this).addClass('create-branch-disabled');
        setTimeout(function(){
            $("#branch-btn").removeClass('create-branch-disabled');
        }, 5000);

        $.ajax({
            type: "POST",
            url: '{% url "createbranch" %}',
            data: {
                'csrfmiddlewaretoken':$('input[name=csrfmiddlewaretoken]').val(),
                'name': branch_name,
                'desc': branch_desc,
            },
            success: function (data) {
                if(data.status == 'success') {
                    toastr.success(data.message)
                    getAllBranchesFunc.call(this);
                    setTimeout(function(){
                        $("#myModal").fadeOut(500);
                    }, 1000);
                }
                else {
                    toastr.warning(data.message)
                }
            },
            error: function (data) {
                console.log(data.message);
            }
        }); 
    }

    $("#branch-btn").click(function(){
        createBranchFunc.call(this);
    });

    $("#fetchBranches").click(function(){
        getAllBranchesFunc.call(this);
    });
});
</script>
{% endblock %}

{% endblock %}